<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <title>MusicTaster</title>
    <link href="http://cdn.bootcss.com/bootstrap/3.3.5/css/bootstrap.min.css" rel="stylesheet">
    <!--<link href="http://cdn.bootcss.com/bootstrap/3.3.5/css/bootstrap-theme.min.css" rel="stylesheet">-->
    <script src="http://cdn.bootcss.com/jquery/2.2.3/jquery.min.js"></script>
    <script src="//cdn.bootcss.com/sigma.js/1.2.0/sigma.min.js"></script>
    <script src="//cdn.bootcss.com/sigma.js/1.2.0/plugins/sigma.parsers.json.min.js"></script>
    <script src="//cdn.bootcss.com/sigma.js/1.2.0/plugins/sigma.layout.forceAtlas2.min.js"></script>
    <script src="//cdn.bootcss.com/sigma.js/1.2.0/plugins/sigma.plugins.dragNodes.min.js"></script>
    <link href="http://cdn.bootcss.com/flat-ui/2.3.0/css/flat-ui.min.css" rel="stylesheet">
    {#    <link rel="icon" href="/static/favicon.ico" type="image/x-icon"/>#}
    <link href="//cdn.bootcss.com/flat-ui/2.3.0/css/flat-ui.min.css" rel="stylesheet">
    <script src="//cdn.bootcss.com/flat-ui/2.3.0/js/flat-ui.min.js"></script>
</head>
<body>
<div class="container" id="main">
    <div class="row">
        <div class="col-md-12">
            <h4 style="align-content: center;">
                MusicTaster
            </h4>

            <p>
                请输入网易云音乐的歌单详情页网址
            </p>
            <hr/>
        </div>
    </div>
    {#    <div class="row">#}
    {#        <div class="col-md-3"></div>#}
    {#        <div class="col-md-2">#}
    {#            <span style="float:right;">摘要句数：</span>#}
    {#        </div>#}
    {#        <div class="col-md-1">#}
    {#            <input style="float: left;" type="number" id="sent_num" class="form-control has-success" value="5">#}
    {#        </div>#}
    {#        <div class="col-md-2">#}
    {#            <button class="btn btn-info" id="btn_send" style="width: 80%;">确认</button>#}
    {#        </div>#}
    {#        <div class="col-md-4"></div>#}
    {#    </div>#}
    <div class="row" style="height: 80%;">
        <div class="col-md-1"></div>
        <div class="col-md-10" style="height: 100%;">
            <div class="row" style="height: 80%;">
                <p>
                    歌单网址：
                </p>
                <textarea style="max-width: 100% ;width:100%;height: 100%;" id="input_url"
                          class="form-control has-success"></textarea>
                <button class="btn btn-info" id="btn_send" style="margin-top: 5%; width: 100%;">确认</button>
                <script>
                    var sig = null;
                    $("#btn_send").click(function () {
                        var pl_url = $("#input_url").val();
                        var send_datas = {
                            url: pl_url,
                            type: "song"
                        };
                        $.ajax('/cluster/playlist/url', {
                            'data': JSON.stringify(send_datas), //{action:'x',params:['a','b','c']}
                            'type': 'POST',
                            'processData': false,
                            'contentType': 'application/json' //typically 'application/x-www-form-urlencoded', but the service you are calling may expect 'text/json'... check with the service to see what they expect as content-type in the HTTP header.
                        }).done(function (data, status) {
                            $("#show_cluster").modal('toggle');
                            if (status == "success") {
                                // parse cluster result
                                //解析聚类结果
                                var resp_obj = eval(data);
                                if (resp_obj['code'] == 200) {
                                    var g = {"nodes": [], "edges": []};
                                    var cluster_result = resp_obj["result"];
                                    g.nodes.push({"id": 'root', 'label': '', 'x': 0, 'y': 0});
                                    for (var i = 0; i < cluster_result.length; i++) {
                                        console.log(cluster_result[i]);
                                        var item = cluster_result[i][0];
                                        var c_color = '#' + (Math.floor(Math.random() * 16777215).toString(16) + '000000').substr(0, 6);
                                        var c_x = (Math.random() - 0.5) * 50;
                                        var c_y = (Math.random() - 0.5) * 50;
                                        g.nodes.push({
                                            "id": item,
                                            "label": item,
                                            'x': c_x,
                                            'y': c_y,
                                            'color': c_color,
                                            'size': 1
                                        });
                                        g.edges.push({
                                            'id': 'root-' + item,
                                            'source': 'root',
                                            'target': item
                                        });
                                        var c_root_id = item;
                                        var last_item = c_root_id;
                                        for (var j = 1; j < cluster_result[i].length; j++) {
                                            //console.log(i + "-" + j);
                                            var n_item = cluster_result[i][j];
                                            g.nodes.push({
                                                "id": n_item,
                                                "label": n_item,
                                                'x': c_x + (Math.random() - 0.5) * 5,
                                                'y': c_y + (Math.random() - 0.5) * 5,
                                                'color': c_color,
                                                'size': 0.5
                                            });
                                            g.edges.push({
                                                'id': c_root_id + '-' + n_item,
                                                'source': c_root_id,
                                                'target': n_item,
                                                'color': c_color
                                            });
                                            if (last_item != c_root_id) {
                                                g.edges.push({
                                                    'id': last_item + '-' + n_item,
                                                    'source': last_item,
                                                    'target': n_item,
                                                    'color': c_color
                                                });
                                            }
                                            last_item = n_item;
                                        }
                                    }
                                    // sigma
                                    sigma.renderers.def = sigma.renderers.canvas;
                                    if (sig) {
                                        sig.clear();
                                        sig.kill();
                                        $("#cluster_canvas").clear();
                                        console.log('kill sig');
                                        sig = new sigma({
                                            graph: g,
                                            container: 'cluster_canvas',
                                            settings: {
                                                defaultNodeColor: '#ec5148',
                                                drawEdges: true,
                                                drawLabels: true,
                                                enableEdgeHovering: true
                                            }
                                        });
                                    } else {
                                        sig = new sigma({
                                            graph: g,
                                            container: 'cluster_canvas',
                                            settings: {
                                                defaultNodeColor: '#ec5148',
                                                drawEdges: true,
                                                drawLabels: true,
                                                enableEdgeHovering: true
                                            }
                                        });
                                    }

                                    var dragListener = new sigma.plugins.dragNodes(sig, sig.renderers[0]);
                                    dragListener.bind('startdrag', function (event) {
                                        console.log(event);
                                    });
                                    dragListener.bind('drag', function (event) {
                                        console.log(event);
                                    });
                                    dragListener.bind('drop', function (event) {
                                        console.log(event);
                                    });
                                    dragListener.bind('dragend', function (event) {
                                        console.log(event);
                                    });
                                    var settings_config = {
                                        worker: true, barnesHutOptimize: false,
                                        adjustSizes: false,
                                        outboundAttractionDistribution: true,
                                        scalingRatio: 2,
                                        gravity: 5,
                                        slowDown: 5

                                    };


                                    var st = function () {
                                        sig.stopForceAtlas2();
                                        console.log('stop');
                                    };

                                    function sta() {
                                        sig.startForceAtlas2(settings_config);
{#                                        setTimeout(st, 10000);#}
                                    }

                                    sta();

                                    {#                                    setTimeout(st,5000);#}
                                } else {
                                    alert("请求错误,详情=" + resp_obj.toString());
                                }


                            } else {
                                alert("请求失败");
                            }
                        }).fail(function () {
                            alert("请求失败");
                        });

                        {#                        $.post("/cluster/playlist/url", send_datas, function (resp_data) {#}
                        {#                            var resp_obj = json(resp_data);#}
                        {#                            //解析聚类结果#}
                        {#                            var cluster_result = resp_obj["result"];#}
                        {#                            for (var i = 0; i < cluster_result.length; i++) {#}
                        {#                                console.log(cluster_result[i]);#}
                        {#                            }#}
                        {##}
                        {#                        }, "application/json");#}
                    });


                    // Add a method to the graph model that returns an
                    // object with every neighbors of a node inside:
                    sigma.classes.graph.addMethod('neighbors', function (nodeId) {
                        var k,
                                neighbors = {},
                                index = this.allNeighborsIndex[nodeId] || {};

                        for (k in index)
                            neighbors[k] = this.nodesIndex[k];

                        return neighbors;
                    });

                </script>
            </div>

        </div>
        {#        <div class="col-md-5" style="height: 100%;">#}
        {#            <div class="row" style="height: 80%;">#}
        {#                <p>#}
        {#                    摘要结果：#}
        {#                </p>#}
        {#                <textarea class="form-control" style="max-width: 100%; width:90%;height: 100%;"#}
        {#                          id="output_text"></textarea>#}
        {#            </div>#}
        {#        </div>#}
        <div class="col-md-1"></div>
    </div>
    <div class="modal fade" id="show_cluster" tabindex="-1" role="dialog"
         aria-hidden="true">
        <div class="modal-dialog" style="width: 1000px;height:800px">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close"
                            data-dismiss="modal" aria-hidden="true">
                        &times;
                    </button>
                    <h4 class="modal-title">
                        歌曲聚类结果
                    </h4>
                </div>
                <div class="modal-body" id="modal_text" style="width: 1000px;height:600px">
                    <div class="modal-body" id="cluster_canvas" style="width: 90%;height: 90%">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default"
                            data-dismiss="modal">关闭
                    </button>
                </div>
            </div>
            <!-- /.modal-content -->
        </div>
        <!-- /.modal -->
    </div>
</div>
</body>
</html>